# Aggro & Threat System Documentation

The aggro/threat system provides intelligent NPC targeting based on damage dealt, tank abilities, and persistent memory across respawns. This enables strategic group combat where tanks can protect squishier party members.

## Table of Contents

- [Overview](#overview)
- [Core Concepts](#core-concepts)
  - [Threat](#threat)
  - [Threat Table](#threat-table)
  - [Grudges](#grudges)
- [Threat Generation](#threat-generation)
  - [Damage Threat](#damage-threat)
  - [Threat Modifiers](#threat-modifiers)
  - [Threat Decay](#threat-decay)
- [Target Selection](#target-selection)
- [Tank Abilities](#tank-abilities)
  - [Taunt](#taunt)
  - [Defensive Stance](#defensive-stance)
- [Grudge System](#grudge-system)
  - [How Grudges Work](#how-grudges-work)
  - [Grudge Persistence](#grudge-persistence)
- [Builder Guide](#builder-guide)
  - [NPC Threat Methods](#npc-threat-methods)
  - [Custom Threat Generation](#custom-threat-generation)
- [Developer Reference](#developer-reference)
  - [ThreatEntry Interface](#threatentry-interface)
  - [GrudgeRecord Interface](#grudgerecord-interface)
  - [AggroDaemon API](#aggrodaemon-api)

---

## Overview

The aggro/threat system determines which player an NPC attacks in combat. Instead of randomly targeting or always attacking the first player, NPCs intelligently prioritize targets based on:

- **Damage dealt**: Players dealing more damage generate more threat
- **Damage type**: Magic damage generates 30% more threat than physical
- **Tank abilities**: Fighters can taunt enemies to protect allies
- **Memory**: NPCs remember players who attacked them and fled

This creates meaningful tactical decisions in group combat:
- Tanks use Defensive Stance to generate extra threat
- DPS players must manage their threat or risk pulling aggro
- Healers generate threat from healing (split among nearby NPCs)
- Players who flee from combat will be remembered and prioritized

---

## Core Concepts

### Threat

**Threat** is a numerical value representing how much an NPC "hates" a particular player. The player with the highest threat is targeted for attacks.

Threat is generated by:
- Dealing damage to the NPC
- Healing allies while the NPC is nearby
- Using taunt abilities
- Having active threat modifier buffs

### Threat Table

Each NPC maintains a **threat table** - a map of player IDs to threat values. This table:
- Tracks all players who have interacted with the NPC
- Decays over time (faster when out of combat)
- Is used to determine attack priority
- Persists for the NPC's lifetime (cleared on death/despawn)

### Grudges

**Grudges** are persistent memories that survive NPC respawns. When a player attacks an NPC and then leaves (fleeing or walking away), the NPC type remembers that player. When the player returns:
- New instances of that NPC type will have initial threat against the player
- The NPC will attack on sight even if not normally aggressive
- Grudges expire after 24 hours

---

## Threat Generation

### Damage Threat

The base threat from dealing damage equals the damage dealt:

| Damage Type | Threat Multiplier | Example |
|-------------|-------------------|---------|
| Physical (slashing, piercing, bludgeoning) | 1.0x | 50 damage = 50 threat |
| Magical (fire, cold, lightning, arcane, holy, necrotic, poison) | 1.3x | 50 damage = 65 threat |
| Healing | 0.5x | 100 healing = 50 threat (split) |

### Threat Modifiers

Several effects modify threat generation:

| Effect | Modifier | Source |
|--------|----------|--------|
| Defensive Stance | +30% to +80% | Fighter skill (level 3) |
| Stealth/Hide | -30% | Thief skills |
| Invisibility | -30% | Mage spell |

**Threat Modifier Calculation:**
```
finalThreat = baseThreat × damageTypeMultiplier × (1 + threatModifier/100) × stealthMultiplier
```

### Threat Decay

Threat decays over time to allow target switching:

| State | Decay Rate | Effect |
|-------|------------|--------|
| In Combat | 1% per second | Slow decay, maintains aggro |
| Out of Combat | 5% per second | Fast decay, allows reset |

When threat drops below 1, the entry is removed from the threat table.

---

## Target Selection

NPCs select targets using this priority:

1. **Taunted Target**: If currently taunted, always attack the taunter
2. **Highest Threat**: Otherwise, attack the player with highest threat
3. **Normal Aggression**: If no threat table entries, use standard aggression rules

Target selection occurs:
- Every heartbeat (for out-of-combat NPCs with threat)
- When the current target dies or leaves
- When a taunt effect is applied

**Algorithm:**
```typescript
getHighestThreatTarget(): Living | null {
  // 1. Apply decay to all entries
  // 2. Remove entries below minimum threshold
  // 3. Filter to valid targets (alive, in room)
  // 4. Return taunted target if active
  // 5. Otherwise return highest threat target
}
```

---

## Tank Abilities

### Taunt

**Taunt** is a Fighter guild skill that forces an NPC to attack you.

| Property | Value |
|----------|-------|
| Guild Level Required | 5 |
| Mana Cost | 20 |
| Cooldown | 15 seconds |
| Duration | 6 seconds |
| Threat Added | 100 + (5 × skill level) |

**Mechanics:**
- Immediately adds threat to the target NPC
- Applies forced targeting for the duration
- NPC cannot switch targets while taunted (even if another player generates more threat)
- After taunt expires, normal threat rules resume

**Usage:**
```
> skill use taunt wolf
You taunt the wolf, forcing them to focus on you for 6 seconds!
```

### Defensive Stance

**Defensive Stance** is a Fighter buff that increases threat generation.

| Property | Value |
|----------|-------|
| Guild Level Required | 3 |
| Mana Cost | 15 |
| Cooldown | 60 seconds |
| Duration | 2 minutes |
| Threat Bonus | +30% to +80% (based on skill level) |

**Mechanics:**
- Self-buff that modifies all threat you generate
- Stacks multiplicatively with damage type modifiers
- Essential for tanks to maintain aggro against high-DPS allies

**Usage:**
```
> skill use defensive_stance
You adopt a defensive stance, drawing enemy attention! (+35% threat for 120s)
```

---

## Grudge System

### How Grudges Work

Grudges allow NPCs to remember players across respawns:

1. **Recording**: When combat ends due to player leaving (flee or walk away):
   - The NPC's current threat against that player is captured
   - A grudge record is created with calculated intensity
   - The grudge is stored by NPC path + player name

2. **Loading**: When a player enters a room with an NPC:
   - The NPC checks for grudges against that player
   - Matching grudges add their intensity as initial threat
   - The NPC will attack based on this threat (even if not normally aggressive)

3. **Expiration**: Grudges expire after 24 hours of real time

### Grudge Persistence

Grudges are persisted to `/data/combat/grudges.json` and survive server restarts.

**Intensity Calculation:**
```
intensity = threat × 0.15
if (player fled) intensity × 1.5
intensity = min(intensity, 500)  // Cap at 500
```

| Factor | Effect |
|--------|--------|
| Base Rate | 15% of threat at separation |
| Flee Bonus | +50% intensity if player used flee command |
| Maximum | 500 (prevents one-shot from grudge alone) |

**Example:**
- Player deals 1000 damage to wolf, threat = 1000
- Player walks away: intensity = 1000 × 0.15 = 150
- Player flees: intensity = 1000 × 0.15 × 1.5 = 225
- Next time player enters room with wolf, wolf has 150-225 initial threat

---

## Builder Guide

### NPC Threat Methods

All NPCs inherit these threat management methods:

```typescript
// Add threat from a source
npc.addThreat(player: Living, amount: number): void

// Get current threat level for a player
npc.getThreat(player: Living): number

// Clear threat (optionally for specific player)
npc.clearThreat(player?: Living): void

// Get the highest threat target in the room
npc.getHighestThreatTarget(): Living | null

// Apply taunt (forced targeting)
npc.applyTaunt(player: Living, durationMs: number): void

// Check if taunted by specific player
npc.isTauntedBy(player: Living): boolean

// Get full threat table (for debugging)
npc.getThreatTable(): Map<string, ThreatEntry>
```

### Custom Threat Generation

You can generate threat from custom NPC abilities:

```typescript
class CustomBoss extends NPC {
  async specialAbility(target: Living): Promise<void> {
    // Deal damage
    target.damage(50);

    // Generate threat manually (if needed beyond auto-generation)
    // Auto-threat is already added by combat daemon on damage

    // Or add bonus threat for special abilities
    this.addThreat(target, 100); // Extra threat for ability use
  }

  // Reduce threat on specific player (threat drop ability)
  reduceThreat(player: Living): void {
    const currentThreat = this.getThreat(player);
    this.clearThreat(player);
    this.addThreat(player, currentThreat * 0.5); // Reduce by 50%
  }
}
```

### Custom Aggression with Threat

Override `onEnter` to customize threat-based aggression:

```typescript
class VengefulNPC extends NPC {
  override async onEnter(who: Living, from?: Room): Promise<void> {
    // Call parent to load grudges
    await super.onEnter(who, from);

    // Add custom behavior
    const threat = this.getThreat(who);
    if (threat > 100) {
      this.say(`${who.name}! I remember you!`);
    }
  }
}
```

---

## Developer Reference

### ThreatEntry Interface

```typescript
interface ThreatEntry {
  /** Living's objectId who generated the threat */
  sourceId: string;

  /** Current threat value */
  threat: number;

  /** Timestamp for decay calculation */
  lastUpdated: number;

  /** Whether this target is being taunted (forced targeting) */
  isTaunted: boolean;

  /** When the taunt effect expires (0 = not taunted) */
  tauntExpires: number;
}
```

### GrudgeRecord Interface

```typescript
interface GrudgeRecord {
  /** NPC's object path (e.g., "/areas/forest/wolf") */
  npcPath: string;

  /** Player's name in lowercase */
  playerName: string;

  /** Historical damage dealt by player */
  totalDamage: number;

  /** Number of times the player fled from this NPC type */
  fleeCount: number;

  /** Timestamp of last encounter */
  lastSeen: number;

  /** Initial threat when re-encountered (max 500) */
  intensity: number;
}
```

### AggroDaemon API

```typescript
import { getAggroDaemon } from '../daemons/aggro.js';

const daemon = getAggroDaemon();

// Add or update a grudge
daemon.addGrudge(record: GrudgeRecord): void

// Get grudges for an NPC (optionally filtered by player)
daemon.getGrudges(npcPath: string, playerName?: string): GrudgeRecord[]

// Clear grudges
daemon.clearGrudges(npcPath?: string, playerName?: string): void

// Calculate intensity from threat
daemon.calculateIntensity(threat: number, fled: boolean): number

// Statistics
daemon.grudgeCount  // Total active grudges
daemon.npcCount     // NPCs with grudges

// Persistence
await daemon.load()   // Load from disk
await daemon.save()   // Save to disk
```

### Effect Types for Threat

Two new effect types support the threat system:

```typescript
type EffectType =
  | 'threat_modifier'  // Modifies threat generation percentage
  | 'taunt'            // Forces NPC target selection
  // ... other effect types
```

**Creating a Threat Modifier Effect:**
```typescript
player.addEffect({
  id: 'custom_threat_buff',
  name: 'Battle Focus',
  type: 'threat_modifier',
  effectType: 'threat_modifier',
  magnitude: 50,  // +50% threat
  duration: 60000,
  category: 'buff',
  description: '+50% threat',
});
```

---

## Configuration Constants

| Constant | Value | Location |
|----------|-------|----------|
| THREAT_DECAY_IN_COMBAT | 1% / second | `npc.ts` |
| THREAT_DECAY_OUT_OF_COMBAT | 5% / second | `npc.ts` |
| THREAT_MINIMUM | 1 | `npc.ts` |
| GRUDGE_EXPIRATION | 24 hours | `aggro.ts` |
| MAX_GRUDGE_INTENSITY | 500 | `aggro.ts` |
| FLEE_BONUS_MULTIPLIER | 1.5 | `aggro.ts` |
| THREAT_TO_INTENSITY_RATE | 0.15 | `aggro.ts` |
| MAGIC_THREAT_MULTIPLIER | 1.3 | `combat.ts` |
| STEALTH_THREAT_REDUCTION | 0.7 | `combat.ts` |

---

## Files Reference

| File | Purpose |
|------|---------|
| `mudlib/std/combat/types.ts` | ThreatEntry interface, EffectType additions |
| `mudlib/std/npc.ts` | Threat table, threat methods, target selection |
| `mudlib/daemons/combat.ts` | Threat generation on damage, grudge recording |
| `mudlib/daemons/aggro.ts` | Grudge persistence daemon |
| `mudlib/daemons/guild.ts` | Taunt skill execution |
| `mudlib/std/guild/definitions.ts` | Taunt and Defensive Stance skill definitions |
| `mudlib/data/combat/grudges.json` | Grudge storage (auto-created) |
